ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
:imagesdir: images/


== Container Images

=== Building Containers with Buildah

==== Building images as the *root* user

.EXAMPLE - Creating a Custom Container Image Using Buildah
=====

. Create a container with Buildah
+
.Creating a Custom Container
[source,bash]
----
[root@server ~]# buildah from scratch
working-container
----

. Inspect the Container
+
.Naming and Inspecting a Custom Container
[source,bash]
----
[root@server ~]# buildah config --label name=Demo-Container working-container
[root@server ~]# buildah inspect working-container
{
    "Type": "buildah 0.0.1",
    "FromImage": "",
    "FromImageID": "",

... OUTPUT OMITTED ...

"History": null,
"Devices": []
}
----

. Mount container disk image and prepare for installation and customization
+
.Installing Packages on Working Container
[source,bash]
----
[root@server ~]# buildah mount working-container
/var/lib/containers/storage/overlay/47059b1cb7f2c518e7f98d905b7ae1bcad78e8962575361bdf7dda36701d38a9/merged <1>

[root@server ~]# export Container_Disk_Image=/var/lib/containers/storage/overlay/47059b1cb7f2c518e7f98d905b7ae1bcad78e8962575361bdf7dda36701d38a9/merged <2>

[root@server ~]# echo $Container_Disk_Image
/var/lib/containers/storage/overlay/47059b1cb7f2c518e7f98d905b7ae1bcad78e8962575361bdf7dda36701d38a9/merged <3>
----
<1> Mount container image filesystem for modification
<2> Export Container Disk Image Mountpoint for easy reference
<3> Verify *Container_Disk_Image* Variable

. Prepare container image for installation of RPM Packages
+
.Download Red Hat Release RPM for installation
[source,bash]
----
[root@server ~]# yumdownloader --destdir=/tmp redhat-release-server
Last metadata expiration check: 23:16:26 ago on Sun 24 Oct 2021 01:57:13 PM EDT.
----

. Install the Red Hat Release RPM to setup GPG keys for repository
+
.Install Red Hat Release RPM
[source,bash]
----
[root@server ~]# rpm -ivh --root $Container_Disk_Image /tmp/redhat-release-8.4-0.6.el8.x86_64.rpm
warning: /tmp/redhat-release-8.4-0.6.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID fd431d51: NOKEY
Verifying...                          ################################# [100%]
Preparing...                          ################################# [100%]
Updating / installing...
   1:redhat-release-8.4-0.6.el8       ################################# [100%]
----

. Setup the Repository on Disk Image
+
.Create repository for container image so files can be installed
[source,bash]
----
[root@server ~]# cp  /etc/yum.repos.d/rhel_dvd.repo $Container_Disk_Image/etc/yum.repos.d/
----

. Install the *httpd* Apache Pacakge to the Container
+
.Install the HTTP package for a webserver
[source,bash]
----
[root@server ~]# yum install --installroot $Container_Disk_Image httpd
----

. Create a custom *index.html* File
+
.Create an *index.html* file for the webserver
[source,bash]
----
[root@server ~]# echo "This is a custom webserver container for me" >> $Container_Disk_Image/var/www/html/index.html
----

. Install the Apache Manual for Webserver Documentation
+
.Install the Apache manual for reference documentation
[source,bash]
----
[root@server ~]# yum install --installroot $Container_Disk_Image httpd-manual
----
+
.Poor Practice
[CAUTION]
====
It is a poor practice to have unneeded items, packages, and documentation in containers. This step normally wouldn't be performed.
====

. Set the Container's Runtime Command
+
.Configure webserver to run
[source,bash]
----
[root@server ~]# buildah config --cmd "/usr/sbin/httpd -DFOREGROUND" working-container
----

. Configure and EXPORT the webserver default port
+
.Configure and open port *80* for the *TCP* protocol for the container
[source,bash]
----
[root@server ~]# buildah config --port 80/tcp working-container
----

. Cleanup unneeded files to conserve space on container image.
+
.Clean up yum data to minimize required disk space
[source,bash]
----
[root@server ~]# yum clean all --installroot $Container_Disk_Image
13 files removed
----

. Unmount Container Filesystem image.
+
.Unmount the container image filesystem
[source,bash]
----
[root@server ~]# buildah unmount working-container
fb5387521fd7b0c9f6dd567ca0f76222178f0ffbcf38fc990df9d49a60079e1
----

. Commit container image to local container registry
+
.Commit the container image
[source,bash]
----
[root@server ~]# buildah commit working-container demo-container-image <1>
Getting image source signatures
Copying blob 1a73c59066af done

... OUTPUT OMITTED ...

Storing signatures
d21ee320b60ad274b010328df6f10f6dfed578623f00855748d8aaa3c29b5e94
----
<1> This will create a container image tagged *demo-container-image* with the *latest* tag.

. View and List Container Images
+
.List container images
[source,bash]
----
[root@server ~]# buildah images | grep demo
localhost/demo-container-image                    latest      d21ee320b60a   About a minute ago   553 MB
----

. Test the Container image by launching a container
+
.Testing the Container Image
[source,bash]
----
[root@server ~]# podman run --name demo-container-buildah -d -p 8880:80 localhost/demo-container-image
be3bbc8898fc6cab1cef5d78721f46b985e957d30984d591271fffcb5b906994

[root@server ~]# curl localhost:8880
This is a custom webserver container for me

[root@server ~]# curl http://localhost:8880/manual/

----

. Test image in Web Browser
+
.Open Firewall Ports
[source,bash]
----
[root@server ~]# firewall-cmd --add-port=8880/tcp --permanent ; firewall-cmd --reload
success
success
----
+
image::Chapter4-1f4e8.png[title="Custom *index.html", align="center"]
+
image::Chapter4-f7bf0.png[title="Apache Manual", align="center"]

.Cleaning up the Container

. Stop and Remove the Container
+
[source,bash]
----
[root@server ~]# podman rm demo-container-buildah --force
be3bbc8898fc6cab1cef5d78721f46b985e957d30984d591271fffcb5b906994
----
+
.Image Removal
[IMPORTANT]
====
Normally we could remove images and cleanup, but we will need to check this image into a registry later. This image shouldn't be removed until it has been checked into a remote container registry.

[source,bash]
----
[root@server ~]# podman rmi localhost/demo-container-image
----

====

. Delete the *working container* image from the system
+
.Delete Working Container from System
[source,bash]
----
[root@server ~]# buildah delete working-container
fb5387521fd7b0c9f6dd567ca0f76222178f0ffbcf38fc990df9d49a60079e18
----

=====

==== Building an Image Using Buildah Rootless


=== Managing Images and System Storage


.References
[NOTE]
====

*Getting into the weeds with Buildah: The buildah unshare command*: https://www.redhat.com/sysadmin/buildah-unshare-command

*How rootless Buildah works: Building containers in unprivileged environments*: https://opensource.com/article/19/3/tips-tricks-rootless-buildah

*Building and managing container images with Buildah*: https://mohitgoyal.co/2021/05/16/building-and-managing-container-images-with-buildah/

*podman-image-prune*: https://docs.podman.io/en/latest/markdown/podman-image-prune.1.html

*podman-system-prune*: https://docs.podman.io/en/latest/markdown/podman-system-prune.1.html

*podman-container-prune* https://docs.podman.io/en/latest/markdown/podman-container-prune.1.html

*Man Pages*: _man podman-image-prune_, _man podman-system-prune_, _man podman-container-prune_, _man buildah_, _man podman_

*Build Containers the Hard Way*: https://github.com/tmichett/build-containers-the-hard-way
====
