ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
:imagesdir: images/
endif::[]


== Building Containers with Buildah



.EXAMPLE - Creating a Custom Container Image Using Buildah
=====
.Creating a Custom Container
[source,bash]
----
[root@workstation ~]# buildah from scratch
working-container
----

.Naming and Inspecting a Custom Container
[source,bash]
----
[root@workstation ~]# buildah config --label name=My-Container working-container
[root@workstation ~]# buildah inspect working-container
----

.Installing Packages on Working Container
[source,bash]
----
[root@workstation ~]#  buildah mount working-container <1>


[root@workstation ~]# yumdownloader --destdir=/tmp redhat-release-server <2>

[root@workstation ~]# rpm -ivh --root /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged /tmp/redhat-release-8.0-0.39.el8.x86_64.rpm <3>

[root@workstation ~]# cp  /etc/yum.repos.d/rhel_dvd.repo /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged/etc/yum.repos.d/ <4>

[root@workstation ~]# yum install --installroot /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged httpd <5>


[root@workstation ~]# echo "This is a custom webserver container for me" >> /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged/var/www/html/index.html <6>

[root@workstation ~]#  yum install --installroot /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged httpd-manual <7>

[root@workstation ~]# buildah config --cmd "/usr/sbin/httpd -DFOREGROUND" working-container <8>

[root@workstation ~]# buildah config --port 80/tcp working-container <9>

[root@workstation ~]# yum clean all --installroot /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged <10>

[root@workstation ~]#  buildah unmount working-container <11>

[root@workstation ~]# buildah commit working-container my-container-image <12>

[root@workstation ~]# buildah images <13>

----
<1> Mount container image filesystem for modification
<2> Download Red Hat Release RPM for installation
<3> Install Red Hat Release RPM
<4> Create repository for container image so files can be installed
<5> Install the HTTP package for a webserver
<6> Create an *index.html* file for the webserver
<7> Install the Apache manual for reference documentation
<8> Configure webserver to run
<9> Configure and open port *80* for the *TCP* protocol for the container
<10> Clean up yum data to minimize required disk space
<11> Unmount the container image filesystem
<12> Commit the container image
<13> List container images

.Testing the Container Image
[source,bash]
----
[root@workstation ~]# podman run -d -p 8080:80 localhost/my-container-image

[root@workstation ~]# curl localhost:8080
This is a custom webserver container for me

[root@workstation ~]# curl http://localhost:8080/manual/

----

image::HTTPD_Container.png[title="Testing Container", align="center"]

.Stopping and Cleanup of Image
[source,bash]
----
[root@workstation ~]# podman list <1>
CONTAINER ID  IMAGE                                COMMAND               CREATED        STATUS           PORTS                 NAMES
9bd572633953  localhost/my-container-image:latest  /usr/sbin/httpd -...  2 seconds ago  Up 1 second ago  0.0.0.0:8080->80/tcp  cranky_stonebraker

[root@workstation ~]# podman stop 9bd572633953 <2>
9bd572633953276ac75417db3ac8e70875a0f2713e8cdfd32253fe343d06153d

[root@workstation ~]# podman stop -a <3>

[root@workstation ~]# podman rm cranky_stonebraker <4>

[root@workstation ~]# podman rm 9bd572633953276ac75417db3ac8e70875a0f2713e8cdfd32253fe343d06153d <5>

[root@workstation ~]# podman rmi localhost/my-container-image <6>

[root@workstation ~]# buildah delete working-container <7>

----
<1> Listing Running Containers
<2> Stopping Single Container by ID
<3> Stopping All Running Containers
<4> Remove Container by Name
<5> Remove Container by ID
<6> Removing Container Image from Registry
<7> Delete Working Container from System
=====

=== Building an Image Using Buildah Rootless
