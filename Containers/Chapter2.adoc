ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
:imagesdir: images/


== Managing Containers with the New Runtime

=== Deploying Containers with the New Container Runtime

==== The Podman Container Engine

RHEL8 includes he *container-tools* package module. New engine is *podman* replaces *docker* and *moby*. It also contains new tools *buildah* to build container images and *skopeo* to manage images on registries like *runc*. The new toolset allows building/running containers without daemons.

image::containers-runtime-stacks.png[title="Docker to RHEL8 Container Runtime", align="center"]

*Container Runtime Toolset*

* Docker replaced with new container runtime
* New toolset supports OCI and reuse of third-party images
* Integrates with *audit* of Docker client-server model
* *container-tools* module provides new container runtime tools and engine.


image::containers-runtime-toolset.svg[title="New Container Runtime", align="center"]

*Describing new Container Runtime Tool*

* The *podman* engine is daemonless and supporting container execution.
* *podman* syntax is similar to the docker command, supporting *Dockerfile* use
* *Buildah* builds container images, from scratch or a Dockerfile.
* Copy and inspect container images in registries with *Skopeo*
* *Skopeo* supports Docker and private registries, the Atomic registry, and local directories, including those which use OCI

[TIP]
====
RHEL8 includes *Pacemaker* containers with *podman* as a tech preview. Pacemaker supports execution of the container across multiple hosts.
====

.Using Container Tools


.Installation of Container Tools
[source,bash]
----
[student@workstation ~]$ sudo yum module install container-tools
----

=== Podman Configuration Files

Depending on whether *podman* is being run as a privileged user or as a *rootless* user, the configuration file locations and directives will be difference.

==== Root-Based Podman

When running Podman as a privileged user, the default configurations are used. Generally these files are not modified, however, it is a common practice to modify the *registries.conf* file to add additional container image registries as well as alter the registry search order.

.Default Configuration Files
* */etc/containers/storage.conf* - Contains information about the default storage for Podman containers when using *podman* in a non-rootless fashion.
* */etc/containers/registries.conf* - Contains information about the registries used for *podman* when doing *podman search* and also for pulling/running of container images.
* */etc/cni/net.d/87-podman-bridge.conflist* - Contains information related to the CNI (container network interface) and IP configuration for the container networks.

==== Rootless Podman

When running *podman* in *rootless* mode, all configuration files will be based on user configurations and are located within the user's home directory.

.User-Based Podman Configuration Files
* */home/student/.config/containers/storage.conf*: Specifies storage configuration for Podman in *rootless* mode.
* */home/student/.config/containers/registries.conf*: Specifies registry configuration for Podman in *rootless* mode.


.Podman User Configuration Files
[IMPORTANT]
====
If the configuration files don't exist in the user's home directory, *podman* will default back up to */etc* for the configuration files and if they aren't there, it will fall back to the */usr/share/containers/* directory.
====


.Podman Configuration File Precedence
[TIP]
====
*podman* has multiple configuration file locations and the order of precedence depends on the if the files exist. Traditionally in a *rootless* implementation, the configuration files with be in the user's *$HOME/.config/containers* directory. In the case of networking, there is no CNI equivalent for *rootless* Podman as *rootless* containers rely on *SLIRP* for networking.

.*Containers.conf*
. *$HOME/.config/containers/containers.conf*
. */etc/containers/containers.conf*
. */usr/share/containers/containers.conf*

.Storage Configurations
. *$HOME/.config/containers/storage.conf*
. */etc/containers/storage.conf*

.Registry Configurations
. *HOME/.config/containers/registries.conf*
. */etc/containers/registries.d/*
. */etc/containers/registries.conf*

Precedence of *1* is the highest and will override all others.
====


.References
[NOTE]
====
* *Podman Project - Config Files and Tutorial*: https://github.com/containers/podman/blob/main/docs/tutorials/rootless_tutorial.md
* *Why can't I use sudo with rootless Podman?*: https://www.redhat.com/sysadmin/sudo-rootless-podman
* *What happens behind the scenes of a rootless Podman container?*: https://www.redhat.com/sysadmin/behind-scenes-podman
* *Rootless containers using Podman*: https://www.redhat.com/sysadmin/rootless-containers-podman
* *Container video series: Rootless containers, process separation, and OpenSCAP*: https://www.redhat.com/sysadmin/container-video-series (Really good by Brian Smith - Former RH TAM, now works in the RHEL Platform BU)
* *Why can’t rootless Podman pull my image?*: https://www.redhat.com/sysadmin/rootless-podman
====


=== Container Image Storage

Containers use ephemeral storage for running containers which is an overlay filesystem with a new read/write (RW) layer added to the original container image. This ephemeral storage is removed once the container is removed from the system. Container images on the other-hand are stored locally on the system in the container image storage registry. It is important to know where the image storage is located for both container images and ephemeral storage for running containers so that it can be monitored for pro-active system administration and cleanup. The storage location for both container images and ephemeral storage is generally defined in the *storage.conf* file.

==== Root-Based Podman

A default installation of Red Hat Container Tools (podman) will create a configuration file for storage located */etc/containers/storage.conf*. These are the most likely settings to be used when running Podman as a *root* user.

.Default Storage Location
[source,bash]
----
[storage]

# Default Storage Driver
driver = "overlay"

# Temporary storage location
runroot = "/var/run/containers/storage"

# Primary Read/Write location of container storage
graphroot = "/var/lib/containers/storage"
----

There are plenty of options regarding containers and image storage, but the primary locations to monitor are */var/run/containers/storage* and */var/lib/containers/storage* as these will be the most used locations by *podman*.

==== Rootless Podman

Podman uses the storage configuration file located *$HOME/.config/containers/storage.conf*. These settings are used because the *overlay* filesystem must use a user-space filesystem overlay so it uses *FUSEFS* storage drives for the user-space filesystems.

.Default Storage Location for Rootless Podman
[source,bash]
----
[storage]
  driver = "overlay"
  runroot = "/run/user/1000"
  graphroot = "/home/student/.local/share/containers/storage" <1>
  [storage.options]

... OUTPUT OMITTED ...

    mount_program = "/usr/bin/fuse-overlayfs" <2>
----
<1> Image storage location
<2> FUSEFS Overlay Filesystem Driver

There are plenty of options regarding containers and image storage, but the primary locations to monitor are */var/run/containers/storage* and */var/lib/containers/storage* as these will be the most used locations by *podman*.


=== Container Networking

Podman is meant to provide all management of containers and the container runtime. Podman is capable of managing the container network (SDN) for root-based Podman containers. The CNI controls the specifications for networking and how the SDN is defined on the system. There is no SDN available for *Rootless* containers as *podman* implements networking for *Rootless* containers using *SLIRP*.

==== Root-Based Podman

Podman root-level containers can leverage CNI. The containers SDN network is defined in the */etc/cni/net.d/87-podman-bridge.conflist* configuration file. Containers can communicate to each other within the SDN on the same system.

.*/etc/cni/net.d/87-podman-bridge.conflist*
[source,json]
----
{
    "cniVersion": "0.4.0",
    "name": "podman",
    "plugins": [
	{
            "type": "bridge", <1>
            "bridge": "cni-podman0", <2>
            "isGateway": true,
            "ipMasq": true,
            "ipam": {
		"type": "host-local",
		"routes": [
		    {
			"dst": "0.0.0.0/0"
		    }
		],
		"ranges": [ <3>
		    [
			{
			    "subnet": "10.88.0.0/16",
			    "gateway": "10.88.0.1"
        }
  		    ]
  		]
              }
  	},
  	{
              "type": "portmap",
              "capabilities": {
  		"portMappings": true
              }
  	},
  	{
              "type": "firewall"
  	}
      ]
  }
----
<1> Defines network type as a *Bridge*
<2> Defines the network name for the bridge as *cni-podman0* for the container SDN
<3> Defines the network IP Address range for the container SDN

==== Rootless Podman

For *rootless* podman the networking for containers leverages *SLIRP*. This is provided by the *slirp4netns* package and provides user-mode networking and namespaces for the networks. Containers running as a *Rootless* container will not receive an IP address from the CNI SDN and cannot communicate with each other or the outside except by using and leveraging *port forwarding*.


.Red Hat Container Catalog
[NOTE]
====
*Red Hat Container Catalog*: https://catalog.redhat.com/software/containers/search
====

=== Managing Containers using the Red Hat Web Console

The Red Hat Web Management Console (Cockpit) can be used to manage container images as well as running containers. However, in order to manage some of the aspects around containers, certain configurations must already be in place.


==== Installing Cockpit Podman Plugins

In order to utilize Cockpit to manage containers with Podman there must be two things that are in place.

.Cockpit *podman* Requirements
* Podman cockpit plugins
* Podman service started and running on the system

. Install *cockpit-podman* Modules
+
.Installation of Cockpit *podman* Plugins
[source,bash]
----
[root@servera ~]# yum install cockpit-podman

... OUTPUT OMITTED ...

Complete!
[root@servera ~]#
----

. Enable *podman* Service in Cockpit
.. Sign into Cockpit
.. Click "*Podman containers*"
.. Click "*Start podman*"
+
image::Chapter2-c0656.png[title="Cockpit - Podman Containers (Setup)", align="center"]
+
image::Chapter2-89d80.png[title="Cockpit - Podman Containers (In-Use)", align="center"]
+
.Ensure Cockpit is both Installed and Enabled
[IMPORTANT]
====

.Installing Cockpit
[source,bash]
----
[root@servera ~]# yum install cockpit

... OUTPUT OMITTED ...

subscription-manager-cockpit-1.28.13-2.el8.noarch
tracer-common-0.7.5-2.el8.noarch

Complete!
----

.Enabling Cockpit Socket
[source,bash]
----
[root@servera ~]# systemctl enable cockpit.socket --now
Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket → /usr/lib/systemd/system/cockpit.socket
----
====


==== Using Cockpit to Manage Containers

Once installed and enabled, the *Podman containers* plugin can begin managing containers and images. There are a few things to remember and consider as the *plugin* can't do everything.

.Plugin Considerations and Limitations
* *Registries*: Image registries must be setup and specified ahead of time in the */etc/containers/registries.conf* file.
** Image registries must be in the configuration file in order for images to be downloaded and used. If the configuration file is updated after the *podman* service has been started, the service must be "restarted" in order for Cockpit to see the changes.
** There are some difficulties with providing authentication information to registries as there isn't currently an interface to login to the registry within Cockpit.
* *Storage Volumes*: It might be necessary to have volumes and permissions setup to properly mount/map the volumes into the running containers

.Container Image Management with Cockpit

. Navigate to the *Images* section and select *Get new image*
+
image::Chapter2-d266c.png[title="Cockpit - Podman Container Images", align="center"]
+
image::Chapter2-4b45a.png[title="Search for Images", align="center"]
. Select the registry to search, tags, and image name/description, then click "Download"
.. Search for the HTTPD-Parent image in the *quay.io* registry.
+
image::Chapter2-9e757.png[title="HTTPD 2.4 Parent Image from Red Hat Training - Quay.io", align="center"]
+
.Adding the *quay.io* Registry to */etc/containers/registries.conf*
[TIP]
====
Update the *registries.conf* file and then restart the *podman* service.

.Edit */etc/containers/registries.conf*
[source,bash]
----
# To ensure compatibility with docker we've included docker.io in the default search list. However Red Hat
# does not curate, patch or maintain container images from the docker.io registry.
[registries.search]
registries = ['registry.access.redhat.com', 'registry.redhat.io', 'docker.io', 'quay.io']<1>
----
<1> Adding *quay.io*


.Restart *podman*
[source,bash]
----
[root@servera ~]# systemctl restart podman.service
----

====
+
.Registry Authentication
[CAUTION]
====
It is important to keep in mind, images requiring authentication to a registry will provide errors in Cockpit as you will be accessing the registry as an unauthenticated user.

image::Chapter2-5a3bb.png[title="Registry Authentication Issues", align="center"]

Based on timeline and platform difficulties, images downloaded in the Red Hat Web Management Console will be coming from public (unauthenticated) registries.
====
. Confirm image was downloaded.
+
image::Chapter2-1bc27.png[title="Images in Local Registry", align="center"]

. Explore image details by clicking the *>* and expanding the available information.
+
image::Chapter2-fb988.png[title="HTTPD-Parent Image Details - Image Information", align="center"]
+
image::Chapter2-2fd80.png[title="Clair Image Details - Containers Using Image", align="center"]

.References
[NOTE]
====

*Oracle Linux: Use Cockpit to Manage Podman Containers*: https://docs.oracle.com/en/operating-systems/oracle-linux/8/tutorial-cockpit-podman/#Before-You-Begin

*Managing your Podman containers with Cockpit on Fedora*: https://www.tutorialworks.com/podman-monitoring-cockpit-fedora/
====
