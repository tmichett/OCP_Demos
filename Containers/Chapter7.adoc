ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
:imagesdir: images/

== Quay Image Registry

The Quay image registry depends on multiple sources and configuration files. The exercises here will go through a local "Proof of Concept" deployment. It will be necessary to open up firewall ports as well as provide persistent storage mount points that can be mounted and accessed within the containers.

There are multiple options for deploying Quay locally. For the purpose of this course, we will be installing the Quay registry with both the Security Scanner and the Mirroring Worker.

.*Quay Deployment Options*
* Stand-Alone Quay  Registry
* Quay Registry with a Mirroring Worker
* Quay Registry with Clair Security Scanner
* *Quay Registry with Clair Security Scanner and Mirroring Worker*
+
.SSL and Security
[IMPORTANT]
====
All deployment scenarios allow the use of creating SSL/TLS certificates to secure the network connection. For the purpose of this content, we will be omitting the steps for generating the SSL/TLS certificates and accessing the registry via HTTPS.
====

.Network Ports for Firewalls and Port Mapping
[cols="4a,4a",options=header]
|===
|Service Name
|Network Port

|Quay HTTPS
|8443/TCP

|Quay HTTP
|8080/TCP

|Quay HTTP
|80/TCP

|Quay HTTPS
|443/TCP

|Postgresql Quay
|5432/TCP

|Postgresql ClairV4
|5433/TCP

|Redis for Quay
|6379

|ClairV4 HTTP
|8081/TCP

|===

.Local Quay Instance Details
* *Server FQDN*: quay.local
* *Images Used*:
** registry.redhat.io/rhel8/postgresql-10:1
** registry.redhat.io/rhel8/redis-5:1
** registry.redhat.io/quay/quay-rhel8:v3.6.0-62
** registry.redhat.io/quay/clair-rhel8:v3.6.0-70
+
.Container Port Mapping
[cols="4a,4a",options=header]
|===
|Container Name
|Mapped Port

|clairv4
|8001:8080

|postgres-clairv4
|5433:5432

|redis
|6379:6379

|postgres
|5432:5432

|quay (_Config Container Only_)
|8080:8080

|quay (_Running Container_)
|80:8080

|===

.Storage Mount Points
[cols="4a,4a,4a",options=header]
|===
|Container Name
|Mount Point on Host System
|Purpose

|quay
|/quay
|Storage for configuration files and images. Multiple sub-directories under this local directory mounted to Quay, Postresql, Redis for persistent storage.

|clairv4
|/etc/clairv4 *=>* /clair
|Storage for configuration files and images.

|===


=== Installing the Quay Image Registry Manually

The Quay registry can be installed as a PoC locally. There is a manual process documented at https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploy_red_hat_quay_for_proof-of-concept_non-production_purposes/index and there is an automated method with Ansible and playbooks created for an Ansible Workshop at https://github.com/tmichett/quay_lab_poc.

.Quay Server Requirements
* RHEL8 Server with Podman Installed
* Access to *registry.redhat.io*
* Firewall ports opened
* */etc/hosts* or DNS entry for Quay server
* Postgresql and Redis containers for Quay
* Postresql container for Clair (if using scanning)

For this workshop, the setup to prepare the environment in Chapter 1 provided the changes for the network needed to be able to successfully install Quay and register the FQDN as *quay.local* on both the *workstation* and *server* systems.

==== Preparing the Server for Quay and Running Supporting Containers

The server needs prepared to run Quay as a service. Firewall ports will need to be opened and the infrastructure containers and components need setup.

.Preparing Infrastructure

. SSH to *server* as the root user
+
[source,bash]
----
[student@workstation ~]$ ssh root@server
----

. Configure Firewall Ports
+
[source,bash]
----
[root@server ~]# firewall-cmd --add-port=80/tcp --add-port=8080/tcp --add-port=443/tcp --add-port=8443/tcp --permanent ; firewall-cmd --reload
success
success
----

. Create Mountpoint and directory and initialize the Quay variable
+
[source,bash]
----
[root@server ~]# mkdir Quay ; export QUAY=/Quay
----

. Create Postgresql Directory for Persistent Storage
+
.Creating Directory
[source,bash]
----
[root@server ~]# mkdir -p $QUAY/postgres-quay
----
+
.Setting up ACL
[source,bash]
----
[root@server ~]# setfacl -m u:26:-wx $QUAY/postgres-quay
----

.Setting up Infrastructure Containers

. Install *container-tools* Module
+
[source,bash]
----
[root@server ~]# yum module install container-tools
----

. Login to the container registry
+
[source,bash]
----
[root@server ~]# podman login registry.redhat.io
Username: tmichett@redhat.com
Password:
Login Succeeded!
----

. Launch the *Postgresql* container
+
[source,bash]
----
[root@server ~]# podman run -d --rm --name postgresql-quay \
> -e POSTGRESQL_USER=quayuser \
> -e POSTGRESQL_PASSWORD=quaypass \
> -e POSTGRESQL_DATABASE=quay \
> -e POSTGRESQL_ADMIN_PASSWORD=adminpass \
> -p 5432:5432 \
> -v $QUAY/postgres-quay:/var/lib/pgsql/data:Z \
> registry.redhat.io/rhel8/postgresql-10:1
Trying to pull registry.redhat.io/rhel8/postgresql-10:1...

... OUTPUT OMITTED ...

Writing manifest to image destination
Storing signatures
c21bf1231538b75d5510b4bd81732ad8f56fa61a98582b985124bd3d5de2ae04
----

. Modify the *Postgresql* database to ensure that *pg_trgm* module has been installed.
+
[source,bash]
----
[root@server ~]# podman exec -it postgresql-quay \
> /bin/bash -c \
> 'echo "CREATE EXTENSION IF NOT EXISTS pg_trgm" \
> | psql -d quay -U postgres'
----

. Setup the *Redis* Container
+
[source,bash]
----
[root@server ~]# podman run -d --rm --name redis \
>  -p 6379:6379 \
> -e REDIS_PASSWORD=strongpassword \
> registry.redhat.io/rhel8/redis-5:1
Trying to pull registry.redhat.io/rhel8/redis-5:1...

... OUTPUT OMITTED ...

Storing signatures
c847b459ded23acdd30e2a6ec1acfdeb3dd79f1457f7f99082cedb0a40447d73
----

.Launch the Quay Configuration Container

. Run the Quay container in configuration mode
+
[source,bash]
----
[root@server ~]# podman run --rm -it --name quay_config \
> -p 8080:8080 \
> registry.redhat.io/quay/quay-rhel8:v3.6.0-62 config secret
Trying to pull registry.redhat.io/quay/quay-rhel8:v3.6.0-62...

... OUTPUT OMITTED ...

2021-10-26 17:54:08,319 INFO success: config-editor entered RUNNING state, process has stayed up for > than 1 seconds (startsecs)
config-editor stdout | time="2021-10-26T17:54:07Z" level=warning msg="An error occurred loading TLS: No public key provided for HTTPS. Server falling back to HTTP."
config-editor stdout | time="2021-10-26T17:54:07Z" level=info msg="Running the configuration editor with HTTP on port 8080 with username quayconfig"
----

. Access a Web Browser and begin the Quay Configuration
.. URL: *quay.local*
.. UN: *quayconfig*
.. PW: *secret*
+
image::Chapter7-9e1d0.png[title="Quay Configuration Login", align="center"]
+
image::Chapter7-b5326.png[title="Quay Configuration Site", align="center"]

. Setup the Server Configuration
.. Server Hostname: *quay.local*
+
image::Chapter7-ac09c.png[title="Quay Server Hostname", align="center"]


. Setup Postgresql Database
.. Postgresql Database Server: *quay.local*
.. Postresql User: *quayuser*
.. Postgresql Password: *quaypass*
.. Postgresql Database: *quay*
.. Postrgresql Admin Password: *adminpass*
+
image::Chapter7-d61cd.png[title="Quay Postgresql DB Setup", align="center"]

. Setup Redis Information
.. Redis Hostname: quay.local
.. Redis Port: 63779
.. Redis Password: strongpassword
+
image::Chapter7-55ad6.png[title="Quay Redis Setup", align="center"]
+
[IMPORTANT]
======
At this point, there is enough configuration to validate and download the Quay config file for launching and running Quay. We will continue to setup *Repository Mirroring*, *Clair Image Scanning*, and *Admin Accounts*.
======

.Setting up Repository Mirroring

. Enable Repository Mirroring
+
image::Chapter7-7569a.png[title="Quay Mirroring Setup", align="center"]
+
[WARNING]
======
Remember to disable SSL as SSL isn't being used for this setup.
======

.Setting up Security Scanning

. Select *Enable Security Scanning*
.. Endpont: *http://quay.local:8081*
.. Select *Generate PSK* (Make note of this as it will need to be used)
.. We will use the PSK of: *MTU5YzA4Y2ZkNzJoMQ==*
+
image::Chapter7-4b13c.png[title="Quay Clair Image Scanning Setup", align="center"]
+
[IMPORTANT]
======
You *MUST* use the Pre-Shared-Key (PSK) of *MTU5YzA4Y2ZkNzJoMQ==* as we will be leveraging a pre-build CLAIR config.yml file.
======


.Configuring Super Users (Admins)

. Add superusers to the system
.. UN: *quayadmin*
.. UN: *_<your_username>_*
+
image::Chapter7-f07c3.png[title="Quay Superuser Setup", align="center"]
+
image::Chapter7-6ac80.png[title="Quay Superuser Setup - Validation", align="center"]

.Completing Quay Configuration - Validating and Download Configuration File

. Validate Configuration Changes
+
image::Chapter7-e60f7.png[title="Quay Setup - Validation", align="center"]

. Download Quay Configuration File
+
image::Chapter7-08c54.png[title="Quay Configuration - File Download", align="center"]

. Stop and Remove the Quay_Config Container
+
.Killing the Container from *server* by hitting _CTRL-C_
[source,bash]
----
... OUTPUT OMITTED ...

Engine"
config-editor stdout | time="2021-10-26T18:30:52Z" level=debug msg="Validating ElasticSearch"
config-editor stdout | time="2021-10-26T18:30:52Z" level=debug msg="Validating ActionLogArchiving"
config-editor stdout | time="2021-10-26T18:30:52Z" level=debug msg="Validating Email"
config-editor stdout | time="2021-10-26T18:30:52Z" level=debug msg="Validating OIDC"

^C

2021-10-26 18:36:55,589 WARN received SIGINT indicating exit request
2021-10-26 18:36:56,591 INFO waiting for stdout, config-editor to die
2021-10-26 18:36:57,596 INFO stopped: config-editor (terminated by SIGTERM)
2021-10-26 18:36:59,599 INFO waiting for stdout to die
2021-10-26 18:37:01,603 INFO stopped: stdout (terminated by SIGTERM")
----



.Quay Next Steps
[TIP]
======
Based on the options in the Quay deployment configuration, it is necessary to setup and configure the Clair Image scanning services before starting the Quay container.
======

==== Preparing Quay and Clair Containers

It is necessary to create a storage location for Quay container images and images that will be loaded into the registry. It is also necessary to copy the Quay configuration file and Clair Configuration files and label them appropriately for use. The Clair scanner will use and leverage Postgresql, so it will also be necessary to setup and configure a Postgresql container for Clair.

.Prepare Quay Storage

. Create Directory for Quay Config
+
[source,bash]
----
[root@server ~]#  mkdir $QUAY/config
----

. Copy download configuration file to $QUAY/config
+
[source,bash]
----
[root@server ~]# scp student@workstation:~/Downloads/quay-config.tar.gz $QUAY/config
----

. Extract the files for use
+
[source,bash]
----
[root@server ~]# cd $QUAY/config ; tar xvf quay-config.tar.gz
extra_ca_certs/
config.yaml
----

. Verify Files and Return to *Home* directory
+
[source,bash]
----
[root@server config]# ls ; cd
config.yaml  extra_ca_certs  quay-config.tar.gz
----

. Create and Prepare Local storage
+
[source,bash]
----
[root@server ~]#  mkdir $QUAY/storage ; setfacl -m u:1001:-wx $QUAY/storage
----

.Prepare and Launch Clair

. Create the Clair Postgres Storage
+
[source,bash]
----
[root@server ~]# mkdir -p $QUAY/postgres-clairv4 ; setfacl -m u:26:-wx $QUAY/postgres-clairv4
----

. Launch *Postgresql* Container
+
[source,bash]
----
[root@server ~]# podman run -d --rm --name postgresql-clairv4 \
> -e POSTGRESQL_USER=clairuser \
> -e POSTGRESQL_PASSWORD=clairpass \
> -e POSTGRESQL_DATABASE=clair \
> -e POSTGRESQL_ADMIN_PASSWORD=adminpass \
> -p 5433:5432 \
> -v $QUAY/postgres-clairv4:/var/lib/pgsql/data:Z \
> registry.redhat.io/rhel8/postgresql-10:1
e0db014a5a2f35cc895ef4ad136695a56ae2cda81c86db804810082ad38b9529
----

. Install *Postgres uuid-ossp module*
+
[source,bash]
----
[root@server ~]# podman exec -it postgresql-clairv4 \
> /bin/bash -c \
> 'echo "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"" \
> | psql -d clair -U postgres'
----

. Create Clair Configuration File and place at */etc/clairv4/config/config.yml*
.. https://github.com/quay/clair/blob/main/Documentation/reference/config.md
.. Use the one already created from *https://github.com/tmichett/quay_lab_poc*
+
.Make the */etc/clairv4/config* Directory
[source,bash]
----
[root@server ~]# mkdir -p /etc/clairv4/config/
----
+
.Copying Config File from Workstation
[source,bash]
----
[root@server ~]# scp student@workstation:~/github/quay_lab_poc/files/clair_config/config.yaml /etc/clairv4/config/
student@workstation's password':
config.yaml                                         100%  845   559.3KB/s   00:00
----
+
[IMPORTANT]
======
The PSK from earlier is used in this file. Please ensure you use the same PSK.
======

. Deploy the Clair Container
+
[source,bash]
----
[root@server ~]# podman run -d --rm --name clairv4 \
> -p 8081:8081 -p 8089:8089 \
> -e CLAIR_CONF=/clair/config.yaml -e CLAIR_MODE=combo \
> -v /etc/clairv4/config:/clair:Z \
> registry.redhat.io/quay/clair-rhel8:v3.6.0-70
Trying to pull registry.redhat.io/quay/clair-rhel8:v3.6.0-70...

... OUTPUT OMITTED ...

Storing signatures
7f5ec8bd697c83fc2ad9277fd76d4c8c8b48048ec45d59f948cd58f87e03295e
----

===== Starting Quay and the Mirroring Containers

. Launch the Quay Container
+
[source,bash]
----
[root@server ~]# podman run -d --rm -p 80:8080 \
> --name=quay \
> -v $QUAY/config:/conf/stack:Z \
> -v $QUAY/storage:/datastorage:Z \
> registry.redhat.io/quay/quay-rhel8:v3.6.0-62
0357e5cfd31fa0336cdc0561bd2d39e332451ba781671abd5b6f2fac2b24c7f0
----

. Launch the Quay Mirroring Container
+
[source,bash]
----
[root@server ~]# podman run -d --name mirroring-worker \
> -v $QUAY/config:/conf/stack:Z \
> registry.redhat.io/quay/quay-rhel8:v3.6.0-62 repomirror
adcd500ae3e0ca7510134d91b4389812cc55ebb2f1f2ebefcfc318f7ce2f6fd9
----

. Verify all containers are running
+
[source,bash]
----
[root@server ~]# podman ps
CONTAINER ID  IMAGE                                          COMMAND         CREATED            STATUS                PORTS                                           NAMES
c21bf1231538  registry.redhat.io/rhel8/postgresql-10:1       run-postgresql  About an hour ago  Up About an hour ago  0.0.0.0:5432->5432/tcp                          postgresql-quay
c847b459ded2  registry.redhat.io/rhel8/redis-5:1             run-redis       About an hour ago  Up About an hour ago  0.0.0.0:6379->6379/tcp                          redis
e0db014a5a2f  registry.redhat.io/rhel8/postgresql-10:1       run-postgresql  20 minutes ago     Up 20 minutes ago     0.0.0.0:5433->5432/tcp                          postgresql-clairv4
7f5ec8bd697c  registry.redhat.io/quay/clair-rhel8:v3.6.0-70                  6 minutes ago      Up 6 minutes ago      0.0.0.0:8081->8081/tcp, 0.0.0.0:8089->8089/tcp  clairv4
0357e5cfd31f  registry.redhat.io/quay/quay-rhel8:v3.6.0-62   registry        3 minutes ago      Up 3 minutes ago      0.0.0.0:80->8080/tcp                            quay
444cf7561b02  registry.redhat.io/quay/quay-rhel8:v3.6.0-62   repomirror      3 seconds ago      Up 3 seconds ago                                                      mirroring-worker
----

.Quay Setup Completed
[CAUTION]
======
At this point the Quay setup has been completed with the Mirroring Worker and Clair v4 Image Scanner. You can proceed to the next steps and skip the section called: *Installing the Quay Image Registry with Ansible*. You should proceed to the section titled *Setting up the Quay Web Console and Testing Quay*.
======


=== Installing the Quay Image Registry with Ansible

There is a Github project that can be used to install a Quay image registry locally which includes a Mirroring and ClairV4 scanning process. The Github repository should have been cloned as part of the exercise in Chapter 1. The Github repository is: https://github.com/tmichett/quay_lab_poc and can deploy a fully functional Quay image registry locally.

The Quay playbooks have been broken down so that they can be run to easily deploy Quay. There are options for deploying based on the configuration files being pre-populated as well as using the Quay container to create the TGZ configuration. There is also a special playbook created to bring already deployed containers back online.

==== Deploying Quay with Ansible

. Change to the *github/quay_lab_poc* directory
+
[source,bash]
----
[student@workstation ~]$ cd github/quay_lab_poc/
----

. Create a registry credential file and update the file with your information
+
.Copy *registry_login.yml_example* to *registry_login.yml*
[source,bash]
----
[student@workstation quay_lab_poc]$ cp registry_login.yml_example registry_login.yml
----
+
.Edit the file *registry_login.yml*
[source,bash]
----
[student@workstation quay_lab_poc]$ vim registry_login.yml
registry_un: UN_Goes_Here <1>
registry_pass: Password_Goes_Here <2>
registry_url: registry.redhat.io
----
<1> Replace with your Red Hat Login ID
<2> Replace with your Red Hat Login Password

. Run the *Quay_Prepare.yml* playbook
+
[source,bash]
----
[student@workstation quay_lab_poc]$ ansible-playbook Quay_Prepare.yml

PLAY [Installation of Packages and Preparing the System] *********************************************************************************************

TASK [Gathering Facts] *******************************************************************************************************************************
ok: [quay.local]

... OUTPUT OMITTED ...

TASK [Start the Quay Config Container] ***************************************************************************************************************
changed: [quay.local]

TASK [Open the Quay Config Container Site] ***********************************************************************************************************
[Open the Quay Config Container Site] <1>
Go to the Quay Configuration container website and enter the appropriate configuration values. For help, look at https://github.com/tmichett/quay_lab/References/Quay-3.5_Deployment.pdf. Login with the credentials provided which are UN: quayconfig and PW: secret. Press 'Enter' when you've completed the configuration and downloaded the file. The file should be placed in the files directory for this playbook.: <2>

... OUTPUT OMITTED ...'

PLAY RECAP *******************************************************************************************************************************************
quay.local                 : ok=13   changed=10   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
----
<1> This allows you to open the Quay Config Site to create a custom configuration file.
<2> Once you've opened the Quay config site and completed the configuration as well as downloaded the file you can hit "Enter". It is also possible to hit "Enter" and skip this step so that the already existing configuration file can be used.
+
.Ansible Failure Possible
[IMPORTANT]
====
It is possible that you will receive an Ansible failure message like this

[source,bash]
----
[student@workstation quay_lab_poc]$ ansible-playbook Quay_Prepare.yml
ERROR! vars file registry_login.yml was not found <1>
Could not find file on the Ansible Controller.
If you are using a module and expect the file to exist on the remote, see the remote_src option
----
<1> This error means you forgot to create/edit the *registry_login.yml* file.

====

. Run the configuration file deployment based on using the TAR config file or the file-based configuration method. *_NOTE: You can only choose one method for configuration._*
+
.File-Based Configuration Method
[source,bash]
----
[student@workstation quay_lab_poc]$ ansible-playbook Quay_Config_Deploy_Files.yml
----
+
.File-Based Configuration Considerations
[IMPORTANT]
====
The *./files/config/config.yaml* file will be used and deployed to control the configuration of the Quay environment.
====
+
.TAR File Configuration Method
[source,bash]
----
[student@workstation quay_lab_poc]$ ansible-playbook Quay_Config_Deploy_Tar.yml
----
+
.TAR-Based Configuration Considerations
[IMPORTANT]
====
The *./files/quay-config.tar.gz* file will be used and deployed to control the configuration of the Quay environment. This file MUST have been created as part of the Quay configuration container process with the WebUI and it must be placed in the *./files/quay-config.tar.gz* before running the playbook.
====

. Deploy the ClairV4 scanning image by executing the *Quay_Clair_Deploy.yml* playbook
+
[source,bash]
----
[student@workstation quay_lab_poc]$ ansible-playbook Quay_Clair_Deploy.yml
----

. Deploy the Quay container registry by executing the *Quay_Deploy.yml* playbook.
+
[source,bash]
----
[student@workstation quay_lab_poc]$ ansible-playbook Quay_Deploy.yml
----

. Deploy the Quay Mirroring Container by executing the *Quay_Mirror_Deploy.yml* playbook.
+
[source,bash]
----
[student@workstation quay_lab_poc]$ ansible-playbook Quay_Mirror_Deploy.yml
----

=== Setting up the Quay Web Console and Testing Quay

After all Quay containers have been configured and installed, it is necessary to setup the Admin (Superuser) for Quay as well as test out the system for both image scanning and the ability to mirror container images from upstream repositories.

==== Configuring the Quay Super User

After the Quay registry has been deployed, it is important to finish configuring the super users (admins) that were defined as part of the setup and configuration file (*config.yaml*) that was created during the Quay preparation section.

It is necessary to look at the *config.yaml* file and configure these users with a password and create the accounts officially before moving forward with utilizing the Quay container registry and the lab environment.

.Configure Quay Super Users
[IMPORTANT]
====
It is possible to either look in the configuration file of the *quay-config.tar.gz* or the actual *config.yaml* file for the *_SUPER_USERS_* section. This is where the usernames are defined that will function as Quay super users.

.Quay Super Users
[source,yaml]
----
SUPER_USERS:
    - quayadmin
    - travis
----
====

. Open the Quay web console by navigating to it in your favorite browser using *http://Quay-FQDN*
+
image::Chapter7-77f15.png[title="Quay Login Page", align="center"]

. Click *Create Account* to create the administrator/superuser accounts for Quay as defined in the *config.yaml* file.
** Repeat this step for all super users in the *config.yaml* file.
+
image::README-aade3.png[]
+
image::README-2085a.png[]
+
image::README-4c04a.png[]

. Verify the account was setup properly and you have *Super User* rights by clicking your Username and looking for *Super User Admin Panel*.
+
image::README-6c250.png[]

==== Testing Quay and ClairV4 Image Scanning

In order to test the scanning capabilities and ensure that things function properly, update a basic image into the Quay Repository

. Login to Local Quay Repository (test authentication and account)
+
.*podman* Authentication
[source,bash]
----
[root@quay ~]# podman login --tls-verify=false quay.local
Username: travis
Password:
Login Succeeded!
----

. Pull and Download an Image, Tag it, then upload to repository
.. Image to download: *quay.io/redhattraining/httpd-parent:2.4*
.. Tag Name: **
+
.Downloading image
[source,bash]
----
[root@server ~]# podman pull quay.io/redhattraining/httpd-parent:2.4
Trying to pull quay.io/redhattraining/httpd-parent:2.4...
Getting image source signatures
Copying blob a3ed95caeb02 done
Copying blob a3ed95caeb02 done
Copying blob a3ed95caeb02 done
Copying blob 787f47dbeaac done
Copying blob a3ed95caeb02 skipped: already exists
Copying blob a3ed95caeb02 skipped: already exists
Copying blob a3ed95caeb02 skipped: already exists
Copying blob 6a5240d60dc4 done
Copying blob 408208567b9a done
Copying blob 08b8c9fdec44 done
Writing manifest to image destination
Storing signatures
3639ce1374d3611e80ed66decd7d5467b72d010c21e19e4f193cd8b944e8c9f5
----
+
.Tagging image
[source,bash]
----
[root@server ~]# podman tag quay.io/redhattraining/httpd-parent:2.4 quay.local/travis/httpd-parent:2.4
----
+
.Push image
[source,bash]
----
[root@server ~]# podman push --tls-verify=false quay.local/travis/httpd-parent:2.4
Getting image source signatures
Copying blob c613b100be16 done
Copying blob a3ed95caeb02 done
Copying blob a3ed95caeb02 done
Copying blob a3ed95caeb02 done
Copying blob 574bcc187eda done
Copying blob 24d85c895b6b done
Copying blob a3ed95caeb02 done
Copying blob a3ed95caeb02 skipped: already exists
Copying blob a3ed95caeb02 skipped: already exists
Copying blob 7f9108fde4a1 done
Writing manifest to image destination
Storing signatures
----

. Verify image exists in Quay
+
image::Chapter7-357d1.png[title="HTTPD Parent Image", align="center"]


. Navigate to image tags and see if the security scan has completed
+
image::Chapter7-a96b8.png[title="HTTPD Parent Image - Image Tags", align="center"]

. Click on Security scan to view the vulnerabilities
+
image::Chapter7-d95ad.png[title="HTTPD Parent Image - Image Vulnerabilities", align="center"]

==== Testing Repository Mirroring

The next step is to ensure that the QUAY Image mirroring container is working and that you can successfully mirror container images from upstream repositories.

. Create a new repository in Quay by clicking *Create New Repository*
+
image::README-a249a.png[]

. Give repository a name and setup the repository visibility
+
image::README-e0e97.png[]

. In the newly created repository, click the *Settings* option from the left-side navigation menu. Set the *Repository State* to *_Mirror_*.
+
image::README-cec53.png[]

. In the newly created repository, click the *Mirroring* option from the left-side navigation menu.
+
image::README-0e703.png[]

. In the *Mirroring* tab, complete the required information for the repository and create a *Robot User*. Click *Enable Mirror*
.. Registry Location - quay.io/redhattraining/httpd-parent
.. Tags: latest and 2.4
+
image::README-5415f.png[]
+
image::README-95133.png[]
+
image::README-e29b8.png[]

. Click "*Sync Now*" to perform immediate synchronization
+
image::README-115df.png[]

. Verify synchronization completed on the *Mirroring* tab as well as the *Tag History*
+
image::README-4189e.png[]
+
image::README-de19a.png[]


==== Using the Quay Image Registry

After testing the initial Quay image registry, we will need to use the registry similar to the one located at Quay.io. It is important to understand that since this repository/registry is local, it is fully maintained by the adminstrators that installed it. There were one or more *Superuser* accounts created as part of the installation process. These accounts can create organizations or modify permissions to organizations as well as maintain the infrastructure.

===== Configuring Quay as the *Superuser*

. Login to the Quay site and open the *Super User Admin Panel*
+
image::Chapter7-31b2b.png[title="Quay Superuser Panel Access", align="center"]
+
image::Chapter7-43ffe.png[title="Quay Superuser - User Management", align="center"]

. Explore the various items on the left-hand menu.

. Navigate to "Messages" and click *Create Message* to create a system-wide message
+
image::Chapter7-51245.png[title="Quay Superuser - System Message", align="center"]

. Create a system message
.. SYSTEM Message:
... **Attention** The system will be scheduled for maintenance on October 31, 2021. It will be in read-only mode for 24-hours. During this time, you can pull existing containers, but accounts and organizations cannot be created and new images will not be able to be published.
+
image::Chapter7-ae3cc.png[title="Quay Superuser - System Message Creation", align="center"]
+
image::Chapter7-90b34.png[title="System Message Verification", align="center"]


===== Creating Organizations

Organizations can be created so that multiple users can share container images. After creating an organization, users can be added to the organization so that they can manage images within that organization.

. Click *Create New Organization*
+
image::Chapter7-d9382.png[title="Creating an Organization", align="center"]

. Provide name for Organization and click *Create Organization*
+
image::Chapter7-7e401.png[title="Red Hat Training Organization", align="center"]
+
[IMPORTANT]
======
When naming the organization, it is important to use all lowercase letters and not have any spaces. Additionally it should be noted that only newer registry versions support naming with "-" and "." in the name.
======

. Manage teams and membership
+
image::Chapter7-6d5f3.png[title="Red Hat Training Organization - Membership", align="center"]

. Create a team
+
image::Chapter7-8049d.png[title="Red Hat Training Organization - Creating a Team", align="center"]
+
image::Chapter7-8dd06.png[title="Red Hat Training Organization - Team Creation", align="center"]
+
image::Chapter7-0f988.png[title="Red Hat Training Organization - Membership Verification", align="center"]

. Add members to the team by clicking the gear and then clicking *Manage Team Members*
+
image::Chapter7-fab2a.png[title="devteam - Membership Modification", align="center"]

. Search for and add team members and add a team description
+
image::Chapter7-1da3d.png[title="devteam - Edit team and members", align="center"]
+
image::Chapter7-eb3fb.png[title="devteam - Final Team Details", align="center"]

. Create default organization permissions
+
image::Chapter7-0a6c2.png[title="Red Hat Training Organization - Permissions", align="center"]
+
image::Chapter7-63094.png[title="Red Hat Training Organization - Dev Team with Write Permissions", align="center"]
+
image::Chapter7-7cfbf.png[title="Red Hat Training Organization - Permission Verification", align="center"]

===== Testing Organizations

Once an organization has been created it is important to test the organization and ensure that members can login and create repositories and are also able to push images to those repositories.

. Login to *quay.local* from the workstation machine
+
[source,bash]
----
[student@workstation ~]$ podman login quay.local --tls-verify=false
Username: travis
Password:
Login Succeeded!
----

. Pull an image down from Quay.io
+
[source,bash]
----
[student@workstation ~]$ podman pull quay.io/redhattraining/hello-world-nginx
Trying to pull quay.io/redhattraining/hello-world-nginx...
Getting image source signatures

... OUTPUT OMITTED ...

Writing manifest to image destination
Storing signatures
8d990e08937e299ce1d9e629e4df86ef824744e9c9d2057a8883553650d25ba9
----

. Tag image for upload to *quay.local*
+
[source,bash]
----
[student@workstation ~]$ podman tag quay.io/redhattraining/hello-world-nginx quay.local/redhattraining/hello-world-nginx
----

. Verify images and tags
+
[source,bash]
----
[student@workstation ~]$ podman images
REPOSITORY                                    TAG      IMAGE ID       CREATED       SIZE
quay.io/redhattraining/hello-world-nginx      latest   8d990e08937e   2 years ago   269 MB
quay.local/redhattraining/hello-world-nginx   latest   8d990e08937e   2 years ago   269 MB
----

. Upload (push) image to *Quay.local* Repository in the *redhattraining* Organization
+
[source,bash]
----
[student@workstation ~]$ podman push quay.local/redhattraining/hello-world-nginx --tls-verify=false
Getting image source signatures

... OUTPUT OMITTED ...

Writing manifest to image destination
Storing signatures
----

. Verify repository appears in Quay WebUI
+
image::Chapter7-1ebf5.png[title="Hello World NGINX Container Image Repository", align="center"]

. Verify the security scanning worked on image
+
image::Chapter7-befee.png[title="hello-world-nginx - Image Tags and Scan Results", align="center"]

. Observe the status of the repository
+
image::Chapter7-bb7cb.png[title="hello-world-nginx - Private (Locked) Repository", align="center"]

. Unlock Repository for Public Use of Image
+
image::Chapter7-94320.png[title="hello-world-nginx - Making Repository Public", align="center"]
+
image::Chapter7-d7a65.png[title="hello-world-nginx - Verifying Unlocked", align="center"]

. SSH to *server* as root
+
[source,bash]
----
[student@workstation ~]$ ssh root@server
----

. Login to the Quay registry
+
[source,bash]
----
[root@server ~]# podman login quay.local --tls-verify=false
Username: travis
Password:
Login Succeeded!
----

. Launch container from the *quay.local/redhattraining/hello-world-nginx* container image.
+
[source,bash]
----
[root@server ~]# podman run -d --name quay_test_nginx -p 10080:8080 quay.local:80/redhattraining/hello-world-nginx
Trying to pull quay.local:80/redhattraining/hello-world-nginx:latest.

... OUTPUT OMITTED ...

Storing signatures
9c9251222721e8ebbd1e38b8a9623b035ba1d814cbfc4dd25fc0256fded25777
----

. Verify webserver is running
+
[source,bash]
----
[root@server ~]# curl localhost:10080
<html>
  <body>
    <h1>Hello, world from nginx!</h1>
  </body>
</html>
----


=== Inspecting Images with Skopeo on Remote Registries

Skopeo is another new command-line utility that can work in conjunction with both Podman, and Buildah. Skopeo can be run as a regular user or root-level user to interact with container images. While both Podman and Buildah work with container images, Skopeo is designed to work with container images and image repositories. Podman is only able to inspect images in the local image registry whereas Skopeo can inspect both local and remote images.

In addition to gaining information about images from remote registries, Skopeo can also perform a wide array of tasks.

.Skopeo Abilities
* Delete images from local or remote image repositories
* Copy images from one image registry to another
* Inspecting remote images
* Syncing images for offline copying to internal registries (air-gapped / isolated environments)
* Login and authenticate to registries

==== Using Skopeo to Inspect Images and Copy Images

The following exercises will leverage Skopeo to inspect the *quay.local/redhattraining/hello-world-nginx* image remotely. They will also copy the image from the *quay.local/redhattraining* to your private repository.

. SSH to *server*
+
[source,bash]
----
[student@workstation ~]$ ssh root@server
----

. Login to *quay.local* with Skopeo
+
[source,bash]
----
[root@server ~]# skopeo login quay.local --tls-verify=false
Authenticating with existing credentials... <1>
Existing credentials are valid. Already logged in to quay.local
----
<1> Skopeo capable of using cached credentials from Podman

. Inspect the Container from Remote Registry
+
[source,bash]
----
[root@server ~]# skopeo inspect docker://quay.local:80/redhattraining/hello-world-nginx
{
    "Name": "quay.local:80/redhattraining/hello-world-nginx",
    "Tag": "latest",
    "Digest": "sha256:72b6f8c7f24e852f6307661bbb0d7bc153137c2c23aa49f6dd16cfd0a8e8093b",
    "RepoTags": [
        "latest"
    ],
    "Created": "2019-06-26T22:59:13.751737399Z",
    "DockerVersion": "",
    "Labels": {
        "architecture": "x86_64",
        "authoritative-source-url": "registry.access.redhat.com",
        "build-date": "2019-04-25T16:26:03.051400",
        "com.redhat.build-host": "cpt-0013.osbs.prod.upshift.rdu2.redhat.com",
        "com.redhat.component": "ubi8-container",
        "com.redhat.license_terms": "https://www.redhat.com/licenses/eulas",
        "description": "The Universal Base Image is designed and engineered to be the base layer for all of your containerized applications, middleware and utilities. This base image is freely redistributable, but Red Hat only supports Red Hat technologies through subscriptions for Red Hat products. This image is maintained by Red Hat and updated regularly.",
        "distribution-scope": "public",
        "io.k8s.description": "The Universal Base Image is designed and engineered to be the base layer for all of your containerized applications, middleware and utilities. This base image is freely redistributable, but Red Hat only supports Red Hat technologies through subscriptions for Red Hat products. This image is maintained by Red Hat and updated regularly.",
        "io.k8s.display-name": "Red Hat Universal Base Image 8",
        "io.openshift.expose-services": "",
        "io.openshift.tags": "base rhel8",
        "maintainer": "Red Hat, Inc.",
        "name": "ubi8",
        "release": "122",
        "summary": "Provides the latest release of Red Hat Universal Base Image 8.",
        "url": "https://access.redhat.com/containers/#/registry.access.redhat.com/ubi8/images/8.0-122",
        "vcs-ref": "d5ff1490fad8f1b57e451d384d3b331e94cf6fe4",
        "vcs-type": "git",
        "vendor": "Red Hat, Inc.",
        "version": "8.0"
    },
    "Architecture": "amd64",
    "Os": "linux",
    "Layers": [
        "sha256:4fc3a6f12060dda18cbd448606cbd27c8dee5e0179f9f76a50a8a1de9e5aa827",
        "sha256:cf8bdd5396ac2c59b14aec87491c8d3c3e6c7be355804b6423f8feeffccbda41",
        "sha256:d5072897bb5d09c20671d4a3714bf9203b13887a3e97df6e7770c65e8e5d949d",
        "sha256:e0ed7e500605c8a40f7717871e9b359e65b239236a094544b89d7b2dda95ba3c",
        "sha256:2eb03ea4690d1339f41ef5082b8644ef44e265b73a008c0e05996f1badeca761",
        "sha256:8e4505e250a0379536b9f1a681943a8585bf258e6c218e29f4f4f70ffee8519a",
        "sha256:a8ab12e20ea0ea02fe1f4b0962365d0c146b988c914a112cdd43605f48a44dc1",
        "sha256:1dbcab28ce46b65c0174e5e82658492107396fead31e9144c343e6bc96e471c7",
        "sha256:1dbcab28ce46b65c0174e5e82658492107396fead31e9144c343e6bc96e471c7",
        "sha256:1dbcab28ce46b65c0174e5e82658492107396fead31e9144c343e6bc96e471c7"
    ],
    "Env": [
        "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
        "container=oci"
    ]
}
----

. Use Skopeo to inspect configuration and layers of the container
+
[source,bash]
----
[root@server ~]# skopeo inspect --config docker://quay.local:80/redhattraining/hello-world-nginx
{
    "created": "2019-06-26T22:59:13.751737399Z",
    "architecture": "amd64",
    "os": "linux",
    "config": {
        "User": "1001",
        "ExposedPorts": {
            "8080/tcp": {}
        },
        "Env": [
            "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
            "container=oci"
        ],
        "Cmd": [
            "/bin/sh",
            "-c",
            "nginx -g \"daemon off;\""
        ],
        "Labels": {
            "architecture": "x86_64",
            "authoritative-source-url": "registry.access.redhat.com",
            "build-date": "2019-04-25T16:26:03.051400",
            "com.redhat.build-host": "cpt-0013.osbs.prod.upshift.rdu2.redhat.com",
            "com.redhat.component": "ubi8-container",
            "com.redhat.license_terms": "https://www.redhat.com/licenses/eulas",
            "description": "The Universal Base Image is designed and engineered to be the base layer for all of your containerized applications, middleware and utilities. This base image is freely redistributable, but Red Hat only supports Red Hat technologies through subscriptions for Red Hat products. This image is maintained by Red Hat and updated regularly.",
            "distribution-scope": "public",
            "io.k8s.description": "The Universal Base Image is designed and engineered to be the base layer for all of your containerized applications, middleware and utilities. This base image is freely redistributable, but Red Hat only supports Red Hat technologies through subscriptions for Red Hat products. This image is maintained by Red Hat and updated regularly.",
            "io.k8s.display-name": "Red Hat Universal Base Image 8",
            "io.openshift.expose-services": "",
            "io.openshift.tags": "base rhel8",
            "maintainer": "Red Hat, Inc.",
            "name": "ubi8",
            "release": "122",
            "summary": "Provides the latest release of Red Hat Universal Base Image 8.",
            "url": "https://access.redhat.com/containers/#/registry.access.redhat.com/ubi8/images/8.0-122",
            "vcs-ref": "d5ff1490fad8f1b57e451d384d3b331e94cf6fe4",
            "vcs-type": "git",
            "vendor": "Red Hat, Inc.",
            "version": "8.0"
        }
    },
    "rootfs": {
        "type": "layers",
        "diff_ids": [
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            ""
        ]
    },
    "history": [
        {
            "created": "2019-04-25T16:26:20.260497942Z",
            "comment": "Imported from -"
        },
        {
            "created": "2019-04-25T16:26:28.425556Z"
        },
        {
            "created": "2019-06-26T22:33:55.170741575Z",
            "created_by": "/bin/sh -c yum install -y --disableplugin=subscription-manager --nodocs nginx   \u0026\u0026 yum clean all"
        },
        {
            "created": "2019-06-26T22:34:02.362527585Z",
            "created_by": "/bin/sh -c #(nop) ADD index.html /usr/share/nginx/html"
        },
        {
            "created": "2019-06-26T22:59:11.622403847Z",
            "created_by": "/bin/sh -c #(nop) ADD nginxconf.sed /tmp/"
        },
        {
            "created": "2019-06-26T22:59:12.412697298Z",
            "created_by": "/bin/sh -c sed -i -f /tmp/nginxconf.sed /etc/nginx/nginx.conf"
        },
        {
            "created": "2019-06-26T22:59:13.277995379Z",
            "created_by": "/bin/sh -c touch /run/nginx.pid   \u0026\u0026 chgrp -R 0 /var/log/nginx /run/nginx.pid   \u0026\u0026 chmod -R g+rwx /var/log/nginx /run/nginx.pid"
        },
        {
            "created": "2019-06-26T22:59:13.414802016Z",
            "created_by": "/bin/sh -c #(nop) EXPOSE 8080"
        },
        {
            "created": "2019-06-26T22:59:13.593338162Z",
            "created_by": "/bin/sh -c #(nop) USER 1001"
        },
        {
            "created": "2019-06-26T22:59:13.751737399Z"
        }
    ]
}
----

. Copy *hello-world-nginx* to your private repository
+
[source,bash]
----
[root@server ~]# skopeo copy --tls-verify=false docker://quay.local/redhattraining/hello-world-nginx docker://quay.local/travis/hello-world-nginx
WARN[0000] '--tls-verify' is deprecated, please set this on the specific subcommand
Getting image source signatures
Copying blob e0ed7e500605 done
Copying blob cf8bdd5396ac done
Copying blob 8e4505e250a0 done
Copying blob d5072897bb5d done
Copying blob a8ab12e20ea0 done
Copying blob 1dbcab28ce46 done
Copying blob 1dbcab28ce46 skipped: already exists
Copying blob 1dbcab28ce46 skipped: already exists
Copying blob 4fc3a6f12060 done
Copying blob 2eb03ea4690d done
Writing manifest to image destination
Storing signatures
----
+
[TIP]
======
Ensure you are logged in

[source,bash]
----
[root@server ~]# skopeo login quay.local --tls-verify=false
Username: travis
Password:
Login Succeeded!
----
======

.References
[NOTE]
====

*Deploy Red Hat Quay for proof-of-concept (non-production) purposes*: https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploy_red_hat_quay_for_proof-of-concept_non-production_purposes/index

*Deploying Quay as a local registry server using local storage and containerized services.*

*Quay Lab PoC*: https://github.com/tmichett/quay_lab_poc
Deploying the Quay Registry locally based on the Proof-of-Concept local deployment.

*Skopeo - Exercise from redhatgov.io*: http://redhatgov.io/workshops/security_openshift/exercise1.4/

*Skopeo on Github*: https://github.com/containers/skopeo

*How to run Skopeo in a container*: https://www.redhat.com/sysadmin/how-run-skopeo-container

*Introduction to using buildah, podman and skopeo to work on containers*: http://redhatgov.io/workshops/rhel_8/exercise1.8/

====
