:pygments-style: tango
:source-highlighter: pygments
:toc:
:toclevels: 7
:sectnums:
:sectnumlevels: 6
:numbered:
:chapter-label:
:icons: font
:imagesdir: images/

== Managing Containers with the New Runtime

=== Deploying Containers with the New Container Runtime

==== The Podman Container Engine

RHEL8 includes he *container-tools* package module. New engine is *podman* replaces *docker* and *moby*. It also contains new tools *buildah* to build container images and *skopeo* to manage images on registries like *runc*. The new toolset allows building/running containers without daemons.

image::containers-runtime-stacks.png[title="Docker to RHEL8 Container Runtime", align="center"]

*Container Runtime Toolset*

* Docker replaced with new container runtime
* New toolset supports OCI and reuse of third-party images
* Integrates with *audit* of Docker client-server model
* *container-tools* module provides new container runtime tools and engine.


image::containers-runtime-toolset.svg[title="New Container Runtime", align="center"]

*Describing new Container Runtime Tool*

* The *podman* engine is daemonless and supporting container execution.
* *podman* syntax is similar to the docker command, supporting *Dockerfile* use
* *Buildah* builds container images, from scratch or a Dockerfile.
* Copy and inspect container images in registries with *Skopeo*
* *Skopeo* supports Docker and private registries, the Atomic registry, and local directories, including those which use OCI

[TIP]
====
RHEL8 includes *Pacemaker* containers with *podman* as a tech preview. Pacemaker supports execution of the container across multiple hosts.
====

.Using Container Tools
====

.Installation of Container Tools
[source,bash]
----
[student@workstation ~]$ sudo yum module install container-tools
----

.Creating a Custom Container
[source,bash]
----
[student@workstation ~]$ buildah from scratch
working-container
----

.Naming and Inspecting a Custom Container
[source,bash]
----
[student@workstation ~]$ buildah config --label name=My-Container working-container
[student@workstation ~]$ buildah inspect working-container
----

.Installing Packages on Working Container
[source,bash]
----
[student@workstation ~]$  buildah mount working-container <1>


[student@workstation ~]$ yumdownloader --destdir=/tmp redhat-release-server <2>

[student@workstation ~]$ rpm -ivh --root /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged /tmp/redhat-release-8.0-0.39.el8.x86_64.rpm <3>

[student@workstation ~]$ cp  /etc/yum.repos.d/rhel_dvd.repo /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged/etc/yum.repos.d/ <4>

[student@workstation ~]$ yum install --installroot /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged httpd <5>


[student@workstation ~]$ echo "This is a custom webserver container for me" >> /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged/var/www/html/index.html <6>

[student@workstation ~]$  yum install --installroot /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged httpd-manual <7>

[student@workstation ~]$ buildah config --cmd "/usr/sbin/httpd -DFOREGROUND" working-container <8>

[student@workstation ~]$ buildah config --port 80/tcp working-container <9>

[student@workstation ~]$ yum clean all --installroot /var/lib/containers/storage/overlay/a6a136063f0ada2b1ed4b01eff9a04b4d6419ae828bc4b49e742bca594e08560/merged <10>

[student@workstation ~]$  buildah unmount working-container <11>

[student@workstation ~]$ buildah commit working-container my-container-image <12>

[student@workstation ~]$ buildah images <13>

----
<1> Mount container image filesystem for modification
<2> Download Red Hat Release RPM for installation
<3> Install Red Hat Release RPM
<4> Create repository for container image so files can be installed
<5> Install the HTTP package for a webserver
<6> Create an *index.html* file for the webserver
<7> Install the Apache manual for reference documentation
<8> Configure webserver to run
<9> Configure and open port *80* for the *TCP* protocol for the container
<10> Clean up yum data to minimize required disk space
<11> Unmount the container image filesystem
<12> Commit the container image
<13> List container images

.Testing the Container Image
[source,bash]
----
[student@workstation ~]$ podman run -d -p 8080:80 localhost/my-container-image

[student@workstation ~]$ curl localhost:8080
This is a custom webserver container for me

[student@workstation ~]$ curl http://localhost:8080/manual/

----

image::HTTPD_Container.png[title="Testing Container", align="center"]

.Stopping and Cleanup of Image
[source,bash]
----
[student@workstation ~]$ podman list <1>
CONTAINER ID  IMAGE                                COMMAND               CREATED        STATUS           PORTS                 NAMES
9bd572633953  localhost/my-container-image:latest  /usr/sbin/httpd -...  2 seconds ago  Up 1 second ago  0.0.0.0:8080->80/tcp  cranky_stonebraker

[student@workstation ~]$ podman stop 9bd572633953 <2>
9bd572633953276ac75417db3ac8e70875a0f2713e8cdfd32253fe343d06153d

[student@workstation ~]$ podman stop -a <3>

[student@workstation ~]$ podman rm cranky_stonebraker <4>

[student@workstation ~]$ podman rm 9bd572633953276ac75417db3ac8e70875a0f2713e8cdfd32253fe343d06153d <5>

[student@workstation ~]$ podman rmi localhost/my-container-image <6>

[student@workstation ~]$ buildah delete working-container <7>

----
<1> Listing Running Containers
<2> Stopping Single Container by ID
<3> Stopping All Running Containers
<4> Remove Container by Name
<5> Remove Container by ID
<6> Removing Container Image from Registry
<7> Delete Working Container from System
====
